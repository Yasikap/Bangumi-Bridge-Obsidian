```dataviewjs
// DataViewJS è¿½ç•ªåˆ—è¡¨ - ç½‘ç«™æ›´æ–°æ£€æµ‹ï¼ˆå¹¶è¡Œæ£€æµ‹ï¼‰
// åªæ˜¾ç¤º"åœ¨çœ‹"çŠ¶æ€çš„ç•ªå‰§ï¼Œæ£€æµ‹ç½‘ç«™æ›´æ–°å¹¶è‡ªåŠ¨ç½®é¡¶
// ä¸­æ–‡åé“¾æ¥åˆ°ç¬”è®°ï¼Œæœ€åä¸€åˆ—æ‰“å¼€è§‚çœ‹ç½‘ç«™

const ROOT_FOLDER = "ACG/Anime";//ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„ç¬”è®°å­˜å‚¨è·¯å¾„

// æ³¨å…¥æ ·å¼
dv.paragraph(`<style>
/* è¡¨æ ¼æ ·å¼ */
.dataview.table-view-table { 
  table-layout: fixed !important; 
  width: 100% !important; 
  border-collapse: collapse !important; 
  font-size: 13px; 
  margin-bottom: 20px;
}
.dataview.table-view-table th, 
.dataview.table-view-table td { 
  padding: 8px 12px !important; 
  line-height: 1.4 !important; 
  vertical-align: middle !important; 
  border: 1px solid var(--background-modifier-border) !important;
}

/* åˆ—å®½è®¾ç½® */
.dataview.table-view-table th:nth-child(1), 
.dataview.table-view-table td:nth-child(1) {  /* ä¸­æ–‡å */
  width: 250px !important;
  min-width: 250px !important;
  white-space: normal !important;
  word-break: break-word !important;
}
.dataview.table-view-table th:nth-child(2), 
.dataview.table-view-table td:nth-child(2) {  /* å¼€æ’­å­£åº¦ */
  width: 120px !important;
  text-align: center !important;
}
.dataview.table-view-table th:nth-child(3), 
.dataview.table-view-table td:nth-child(3) {  /* æ›´æ–°çŠ¶æ€ */
  width: 140px !important;
  text-align: center !important;
  white-space: nowrap !important;
}
.dataview.table-view-table th:nth-child(4), 
.dataview.table-view-table td:nth-child(4) {  /* æ‰“å¼€ç½‘å€ */
  width: 80px !important;
  text-align: center !important;
}

/* é“¾æ¥æ ·å¼ */
.note-link {
  color: var(--text-normal) !important;
  text-decoration: none !important;
  cursor: pointer !important;
  font-weight: 500 !important;
  padding: 4px 0 !important;
  display: block !important;
  transition: all 0.2s ease !important;
}
.note-link:hover {
  color: var(--text-accent) !important;
  text-decoration: underline !important;
  background: rgba(var(--text-accent-rgb), 0.05) !important;
  border-radius: 4px !important;
  padding: 4px 8px !important;
  margin: 0 -8px !important;
}
.note-link.has-update {
  font-weight: bold !important;
  color: #ff6b6b !important;
}

/* ç½‘ç«™æŒ‰é’®æ ·å¼ */
.site-btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 6px !important;
  border: 1px solid #339af0 !important;
  border-radius: 6px !important;
  background: rgba(51, 154, 240, 0.1) !important;
  color: #339af0 !important;
  text-decoration: none !important;
  cursor: pointer !important;
  font-size: 14px !important;
  transition: all 0.2s ease !important;
  width: 32px !important;
  height: 32px !important;
  min-width: auto !important;
}
.site-btn:hover {
  background: rgba(51, 154, 240, 0.2) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}
.site-btn:disabled, .site-btn.disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  border-color: #868e96 !important;
  background: rgba(134, 142, 150, 0.1) !important;
  color: #868e96 !important;
}
.site-btn:hover:disabled {
  transform: none !important;
  box-shadow: none !important;
}

/* æ›´æ–°çŠ¶æ€æ ·å¼ */
.status-update { 
  color: #ff6b6b !important; 
  font-weight: bold !important;
  animation: pulse 2s infinite;
}
.status-synced { 
  color: #51cf66 !important; 
  font-weight: 500 !important;
}
.status-failed { 
  color: #ff922b !important; 
  font-style: italic !important;
}
.status-no-url { 
  color: #868e96 !important; 
  font-style: italic !important;
}

/* è„‰å†²åŠ¨ç”» */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

/* ç½®é¡¶è¡Œæ ·å¼ */
.pinned-row {
  background: rgba(255, 107, 107, 0.05) !important;
  border-left: 3px solid #ff6b6b !important;
}

/* åŠ è½½çŠ¶æ€ */
.loading-status {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 6px;
  padding: 10px 15px;
  margin: 10px 0;
  text-align: center;
  color: #856404;
}
</style>`);

// æ˜¾ç¤ºæ ‡é¢˜å’ŒåŠ è½½çŠ¶æ€
dv.el("h2", "ğŸ“º è¿½ç•ªåˆ—è¡¨ - åœ¨çœ‹");
const loadingElement = dv.el("div", "â³ æ­£åœ¨å¹¶è¡Œæ£€æµ‹ç½‘ç«™æ›´æ–°ï¼Œè¯·ç¨å€™...", {
  attr: { class: "loading-status" }
});

// --- å·¥å…·å‡½æ•° ---

// ä»Frontmatteræå–å­—æ®µ
function extractFrontmatter(content) {
    if (!content) return null;
    
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
    if (!frontmatterMatch) return null;
    
    const yamlContent = frontmatterMatch[1];
    const frontmatter = {};
    
    yamlContent.split('\n').forEach(line => {
        const match = line.match(/^([^:]+):\s*(.+)$/);
        if (match) {
            let value = match[2].trim();
            if ((value.startsWith('"') && value.endsWith('"')) || 
                (value.startsWith("'") && value.endsWith("'"))) {
                value = value.substring(1, value.length - 1);
            }
            frontmatter[match[1].trim()] = value;
        }
    });
    
    return frontmatter;
}

// æå–å·²è§‚çœ‹é›†æ•°
function extractWatchedEpisodes(content) {
    if (!content) return 0;
    
    const patterns = [
        /\*\*å·²è§‚çœ‹é›†æ•°\*\*ï¼š\s*(\d+(\.\d+)?)/,
        /å·²è§‚çœ‹é›†æ•°[:ï¼š]\s*(\d+(\.\d+)?)/,
        /watched.*?[:ï¼š]\s*(\d+(\.\d+)?)/i,
        /çœ‹åˆ°.*?[:ï¼š]\s*(\d+(\.\d+)?)/,
        /è¿›åº¦.*?[:ï¼š]\s*(\d+(\.\d+)?)/
    ];
    
    for (const pattern of patterns) {
        const match = content.match(pattern);
        if (match && match[1]) {
            const num = parseFloat(match[1]);
            if (!isNaN(num)) {
                return num;
            }
        }
    }
    
    return 0;
}

// ä»æ­£æ–‡ä¸­æå–è§‚çœ‹ç½‘å€
function extractWatchUrl(content) {
    if (!content) return null;
    
    const markdownPattern = /\*\*è§‚çœ‹ç½‘å€\*\*ï¼š\s*\[[^\]]+\]\(([^)]+)\)/;
    const markdownMatch = content.match(markdownPattern);
    
    if (markdownMatch && markdownMatch[1]) {
        return markdownMatch[1].trim();
    }
    
    const urlPatterns = [
        /\*\*è§‚çœ‹ç½‘å€\*\*ï¼š\s*([^\s\n]+)/,
        /è§‚çœ‹ç½‘å€[:ï¼š]\s*([^\s\n]+)/
    ];
    
    for (const pattern of urlPatterns) {
        const match = content.match(pattern);
        if (match && match[1]) {
            return match[1].trim();
        }
    }
    
    return null;
}

// ä»è·¯å¾„æå–å­£åº¦ä¿¡æ¯
function extractSeasonFromPath(filePath) {
    if (!filePath) return "æœªçŸ¥å­£åº¦";
    
    const patterns = [
        /\/(\d{4})\/(\d{2})æœˆæ–°ç•ª/,
        /\/(\d{4})å¹´(\d{1,2})æœˆ/,
        /(\d{4})[-\/](\d{1,2})/
    ];
    
    for (const pattern of patterns) {
        const match = filePath.match(pattern);
        if (match) {
            const year = match[1];
            const month = match[2].padStart(2, '0');
            return `${year}å¹´${month}æœˆ`;
        }
    }
    return "æœªçŸ¥å­£åº¦";
}

// ä»HTMLä¸­æå–æœ€å¤§é›†æ•°
function extractMaxEpisodeFromHTML(html) {
    if (!html) return 0;
    
    const episodePatterns = [
        /ç¬¬\s*(\d+)\s*é›†/g,
        /ç¬¬\s*(\d+)\s*è¯/g,
        /Episode\s*(\d+)/gi,
        /ep\.\s*(\d+)/gi
    ];
    
    let maxEpisode = 0;
    
    for (const pattern of episodePatterns) {
        const matches = [...html.matchAll(pattern)];
        for (const match of matches) {
            const num = parseInt(match[1]);
            if (!isNaN(num) && num > 0 && num > maxEpisode) {
                maxEpisode = num;
            }
        }
    }
    
    return maxEpisode;
}

// ç½‘ç«™æ›´æ–°æ£€æµ‹å‡½æ•°
async function checkWebsiteUpdate(watchUrl, content) {
    try {
        const actualWatchUrl = extractWatchUrl(content) || watchUrl;
        
        if (!actualWatchUrl || actualWatchUrl === "æ— " || actualWatchUrl === "æœªè®¾ç½®" || actualWatchUrl.trim() === "") {
            return { 
                hasUpdate: false, 
                error: "æœªè®¾ç½®è§‚çœ‹ç½‘å€",
                latestEpisode: 0,
                watchedEpisodes: 0,
                updateCount: 0
            };
        }
        
        const watchedEpisodes = extractWatchedEpisodes(content);
        
        let htmlContent = "";
        let error = null;
        
        try {
            const response = await requestUrl({
                url: actualWatchUrl,
                method: 'GET',
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                },
                timeout: 10000
            });
            htmlContent = response.text;
        } catch (fetchError) {
            error = `ç½‘ç»œè¯·æ±‚å¤±è´¥: ${fetchError.message}`;
        }
        
        if (error) {
            return { 
                hasUpdate: false, 
                error: error,
                latestEpisode: 0,
                watchedEpisodes,
                updateCount: 0
            };
        }
        
        const latestEpisode = extractMaxEpisodeFromHTML(htmlContent);
        
        if (latestEpisode === 0) {
            return { 
                hasUpdate: false, 
                error: "æœªæ‰¾åˆ°å‰§é›†ä¿¡æ¯",
                latestEpisode: 0,
                watchedEpisodes,
                updateCount: 0
            };
        }
        
        const updateCount = Math.max(0, latestEpisode - watchedEpisodes);
        const hasUpdate = updateCount > 0;
        
        return {
            hasUpdate,
            error: null,
            latestEpisode,
            watchedEpisodes,
            updateCount,
            watchUrl: actualWatchUrl
        };
        
    } catch (error) {
        return { 
            hasUpdate: false, 
            error: `æ£€æµ‹å¤±è´¥: ${error.message}`,
            latestEpisode: 0,
            watchedEpisodes: 0,
            updateCount: 0
        };
    }
}

// åˆ›å»ºæ›´æ–°çŠ¶æ€å•å…ƒæ ¼
function createUpdateStatusCell(updateInfo) {
    if (updateInfo.error === "æœªè®¾ç½®è§‚çœ‹ç½‘å€") {
        return dv.el("span", "æœªè®¾ç½®", { 
            attr: { 
                class: "status-no-url",
                title: "è¯·åœ¨ç¬”è®°ä¸­è®¾ç½®è§‚çœ‹ç½‘å€"
            }
        });
    }
    
    if (updateInfo.error) {
        return dv.el("span", "âŒå¤±è´¥", { 
            attr: { 
                class: "status-failed",
                title: updateInfo.error
            }
        });
    }
    
    if (updateInfo.hasUpdate) {
        return dv.el("span", `ğŸ†•å·²æ›´æ–°${updateInfo.updateCount}é›†`, { 
            attr: { 
                class: "status-update",
                title: `å·²çœ‹: ${updateInfo.watchedEpisodes}é›†, æœ€æ–°: ${updateInfo.latestEpisode}é›†`
            }
        });
    } else {
        return dv.el("span", `âœ… å·²åŒæ­¥`, { 
            attr: { 
                class: "status-synced",
                title: `å·²çœ‹: ${updateInfo.watchedEpisodes}é›†, æœ€æ–°: ${updateInfo.latestEpisode}é›†`
            }
        });
    }
}

// åˆ›å»ºç¬”è®°é“¾æ¥
function createNoteLink(filePath, chineseName, hasUpdate) {
    return dv.el("a", chineseName, {
        href: filePath,
        attr: {
            class: `note-link ${hasUpdate ? 'has-update' : ''}`,
            "data-href": filePath,
            onclick: `app.workspace.openLinkText("${filePath}", "", false); return false;`
        }
    });
}

// åˆ›å»ºç½‘ç«™æŒ‰é’®
function createWebsiteButton(updateInfo) {
    if (!updateInfo.watchUrl || updateInfo.error === "æœªè®¾ç½®è§‚çœ‹ç½‘å€") {
        return dv.el("span", "â€”", {
            attr: {
                class: "site-btn disabled",
                title: updateInfo.error || "æ— ç½‘å€"
            }
        });
    }
    
    return dv.el("button", "ğŸŒ", {
        attr: {
            class: "site-btn",
            onclick: `window.open("${updateInfo.watchUrl}", "_blank"); return false;`,
            title: `æ‰“å¼€è§‚çœ‹ç½‘ç«™: ${updateInfo.watchUrl}`
        }
    });
}

// ä¸»ç¨‹åº
try {
    // æ”¶é›†æ‰€æœ‰bangumiç¬”è®°
    const pages = dv.pages().where(p => 
        p.file && 
        p.file.path && 
        p.file.path.startsWith(ROOT_FOLDER) &&
        p.tags && 
        (p.tags.includes("bangumi") || p.tags === "bangumi")
    ).array();
    
    const watchingItems = [];
    
    // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰éœ€è¦æ£€æµ‹çš„ç•ªå‰§ä¿¡æ¯
    for (const page of pages) {
        try {
            const filePath = page.file.path;
            const content = await app.vault.read(app.vault.getAbstractFileByPath(filePath));
            
            const frontmatter = extractFrontmatter(content);
            if (!frontmatter) continue;
            
            if (frontmatter.è§‚çœ‹çŠ¶æ€ !== "åœ¨çœ‹") continue;
            
            const chineseName = frontmatter.ä¸­æ–‡å || page.file.name.replace('.md', '');
            const watchUrl = frontmatter.è§‚çœ‹ç½‘å€;
            const season = extractSeasonFromPath(filePath);
            
            watchingItems.push({
                filePath,
                chineseName,
                season,
                watchUrl,
                content
            });
            
        } catch (error) {
            // é™é»˜å¤„ç†é”™è¯¯
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ç½‘ç«™æ£€æµ‹
    loadingElement.textContent = `â³ æ­£åœ¨å¹¶è¡Œæ£€æµ‹ ${watchingItems.length} ä¸ªç•ªå‰§çš„ç½‘ç«™æ›´æ–°...`;
    
    const updatePromises = watchingItems.map(item => 
        checkWebsiteUpdate(item.watchUrl, item.content)
    );
    
    const updateResults = await Promise.all(updatePromises);
    
    // ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶æ£€æµ‹ç»“æœ
    for (let i = 0; i < watchingItems.length; i++) {
        watchingItems[i].updateInfo = updateResults[i];
        watchingItems[i].hasUpdate = updateResults[i].hasUpdate;
    }
    
    // ç§»é™¤åŠ è½½çŠ¶æ€
    loadingElement.remove();
    
    // ç»Ÿè®¡ä¿¡æ¯
    const totalCount = watchingItems.length;
    const updateCount = watchingItems.filter(item => item.hasUpdate).length;
    const hasUrlCount = watchingItems.filter(item => 
        item.updateInfo.error !== "æœªè®¾ç½®è§‚çœ‹ç½‘å€").length;
    const failedCount = watchingItems.filter(item => 
        item.updateInfo.error && item.updateInfo.error !== "æœªè®¾ç½®è§‚çœ‹ç½‘å€").length;
    
    if (totalCount > 0) {
        dv.paragraph(`**ğŸ“Š ç»Ÿè®¡ï¼š** ${totalCount} éƒ¨ç•ªå‰§ä¸­ï¼Œ${hasUrlCount} éƒ¨è®¾ç½®ç½‘å€ï¼Œ${updateCount} éƒ¨æœ‰æ›´æ–°ï¼Œ${failedCount} éƒ¨æ£€æµ‹å¤±è´¥\n`);
    }
    

    // æ’åºï¼šæœ‰æ›´æ–°çš„ç½®é¡¶ï¼Œç„¶åæŒ‰æ›´æ–°é›†æ•°é™åºï¼Œç„¶åæŒ‰å­£åº¦æ’åº
	watchingItems.sort((a, b) => {
    // é¦–å…ˆï¼Œæœ‰æ›´æ–°çš„æ’åœ¨å‰é¢
	    if (a.hasUpdate && !b.hasUpdate) return -1;
	    if (!a.hasUpdate && b.hasUpdate) return 1;
    
	// å¦‚æœéƒ½æœ‰æ›´æ–°ï¼ŒæŒ‰æ›´æ–°é›†æ•°ä»å¤§åˆ°å°æ’åº
	    if (a.hasUpdate && b.hasUpdate) {
	        if (a.updateInfo.updateCount > b.updateInfo.updateCount) return -1;
	        if (a.updateInfo.updateCount < b.updateInfo.updateCount) return 1;
    }
    
	// ç„¶åæŒ‰å­£åº¦æ’åºï¼ˆæ–°å­£åº¦åœ¨å‰ï¼‰
	    const seasonA = a.season;
	    const seasonB = b.season;
	    if (seasonA !== seasonB) {
	        return seasonB.localeCompare(seasonA);
    }
    
    // æœ€åæŒ‰ä¸­æ–‡åæ’åº
	    return a.chineseName.localeCompare(b.chineseName, "zh-CN");
});
    // ç”Ÿæˆè¡¨æ ¼
    const tableRows = watchingItems.map(item => {
        return [
            createNoteLink(item.filePath, item.chineseName, item.hasUpdate),
            dv.span(item.season),
            createUpdateStatusCell(item.updateInfo),
            createWebsiteButton(item.updateInfo)
        ];
    });
    
    // æ˜¾ç¤ºè¡¨æ ¼
    if (tableRows.length > 0) {
        dv.table(
            ["ä¸­æ–‡å", "å¼€æ’­å­£åº¦", "æ›´æ–°çŠ¶æ€", "æ‰“å¼€ç½‘å€"],
            tableRows
        );
    } else {
        dv.paragraph("> æ²¡æœ‰æ‰¾åˆ°çŠ¶æ€ä¸º'åœ¨çœ‹'çš„ç•ªå‰§ç¬”è®°ï¼Œæˆ–æœªè®¾ç½®è§‚çœ‹ç½‘å€ã€‚");
    }
    
} catch (error) {
    // ç¡®ä¿åŠ è½½çŠ¶æ€è¢«ç§»é™¤
    if (loadingElement && loadingElement.remove) {
        loadingElement.remove();
    }
    dv.paragraph(`âŒ ç”Ÿæˆè¿½ç•ªåˆ—è¡¨å¤±è´¥ï¼š${error.message}`);
}

    // ä½¿ç”¨è¯´æ˜
    dv.paragraph(`
---
**ğŸ¯ ä½¿ç”¨è¯´æ˜ï¼š**

1. **è®¾ç½®è§‚çœ‹ç½‘å€**ï¼šåœ¨ç¬”è®°æ­£æ–‡ä¸­æ·»åŠ  \`**è§‚çœ‹ç½‘å€**ï¼š [é“¾æ¥æ–‡æœ¬](https://example.com)\`
2. **æ›´æ–°è§‚çœ‹è¿›åº¦**ï¼šåœ¨ç¬”è®°æ­£æ–‡ä¸­æ›´æ–° \`**å·²è§‚çœ‹é›†æ•°**ï¼š6\`
3. **ç‚¹å‡»ä¸­æ–‡å**ï¼šåœ¨Obsidianä¸­æ‰“å¼€ç•ªå‰§ç¬”è®°
4. **ç‚¹å‡»ğŸŒå›¾æ ‡**ï¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è§‚çœ‹ç½‘ç«™

**ğŸ“ ç¬”è®°æ ¼å¼è¦æ±‚ï¼š**
\`\`\`
---
è§‚çœ‹çŠ¶æ€: åœ¨çœ‹
ä¸­æ–‡å: ç•ªå‰§åç§°
---

**å·²è§‚çœ‹é›†æ•°**ï¼š 0
**è§‚çœ‹ç½‘å€**ï¼š [ã€Šå‹‡è€…å¤„åˆ‘ æƒ©ç½šå‹‡è€…9004é˜Ÿæœåˆ‘è®°å½•ã€‹ç®€ä»‹ - ä¸ƒè‰²ç•ªåŠ¨æ¼«è§†é¢‘ç½‘](https://www.7sefun.top/voddetail/26875.html)
\`\`\`
    `);
 
```

