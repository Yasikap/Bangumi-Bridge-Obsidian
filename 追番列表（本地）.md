```dataviewjs
// DataViewJS è¿½ç•ªåˆ—è¡¨ - æœ¬åœ°æ–‡ä»¶å¤¹æ£€æµ‹ï¼ˆæ·»åŠ æ›´æ–°é›†æ•°æ˜¾ç¤ºï¼‰
// åªæ˜¾ç¤º"åœ¨çœ‹"çŠ¶æ€çš„ç•ªå‰§ï¼Œæœ‰æ›´æ–°çš„è‡ªåŠ¨ç½®é¡¶
// ä¸­æ–‡åé“¾æ¥åˆ°ç¬”è®°ï¼Œæœ€åä¸€åˆ—æ‰“å¼€ä¸‹è½½æ–‡ä»¶å¤¹

const ROOT_FOLDER = "ACG/Anime";//ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„ç¬”è®°å­˜å‚¨è·¯å¾„

// æ³¨å…¥æ ·å¼
dv.paragraph(`<style>
/* è¡¨æ ¼æ ·å¼ */
.dataview.table-view-table { 
  table-layout: fixed !important; 
  width: 100% !important; 
  border-collapse: collapse !important; 
  font-size: 13px; 
  margin-bottom: 20px;
}
.dataview.table-view-table th, 
.dataview.table-view-table td { 
  padding: 4px 6px !important; 
  line-height: 1 !important; 
  vertical-align: middle !important; 
  border: 1px solid var(--background-modifier-border) !important;
}

/* åˆ—å®½è®¾ç½® */
.dataview.table-view-table th:nth-child(1), 
.dataview.table-view-table td:nth-child(1) {  /* ä¸­æ–‡åï¼ˆé“¾æ¥åˆ°ç¬”è®°ï¼‰ */
  min-width: 220px !important;
  max-width: 220px !important;
  white-space: normal !important;
  word-break: break-word !important;
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
}
.dataview.table-view-table th:nth-child(2), 
.dataview.table-view-table td:nth-child(2) {  /* å¼€æ’­å­£åº¦ */
  width: 100px !important;
  text-align: center !important;
}
.dataview.table-view-table th:nth-child(3), 
.dataview.table-view-table td:nth-child(3) {  /* æ›´æ–°çŠ¶æ€ */
  width: 120px !important;
  text-align: center !important;
  white-space: nowrap !important;
}
.dataview.table-view-table th:nth-child(4), 
.dataview.table-view-table td:nth-child(4) {  /* æ‰“å¼€æ–‡ä»¶å¤¹ */
  width: 100px !important;
  text-align: center !important;
}

/* é“¾æ¥æ ·å¼ */
.note-link {
  color: var(--text-normal) !important;
  text-decoration: none !important;
  cursor: pointer !important;
  font-weight: normal !important;
  transition: all 0.2s ease !important;
  display: block !important;
  width: 100% !important;
  padding: 4px 0 !important;
}
.note-link:hover {
  color: var(--text-accent) !important;
  text-decoration: underline !important;
  background: rgba(var(--text-accent-rgb), 0.05) !important;
  border-radius: 4px !important;
  padding: 4px 8px !important;
  margin: 0 -8px !important;
}
.note-link.pinned {
  font-weight: bold !important;
  color: #ff6b6b !important;
}

/* æ–‡ä»¶å¤¹æŒ‰é’®æ ·å¼ */
.folder-btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 6px 12px !important;
  border: 1px solid #339af0 !important;
  border-radius: 6px !important;
  background: rgba(51, 154, 240, 0.1) !important;
  color: #339af0 !important;
  text-decoration: none !important;
  cursor: pointer !important;
  font-size: 12px !important;
  transition: all 0.2s ease !important;
  width: auto !important;
  min-width: 80px !important;
  margin: 0 auto !important;
}
.folder-btn:hover {
  background: rgba(51, 154, 240, 0.25) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
}
.folder-btn:disabled, .folder-btn.disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  border-color: #868e96 !important;
  background: rgba(134, 142, 150, 0.1) !important;
  color: #868e96 !important;
}
.folder-btn:hover:disabled {
  transform: none !important;
  box-shadow: none !important;
}

/* çŠ¶æ€æ ·å¼ */
.status-new { 
  color: #ff6b6b !important; 
  font-weight: bold !important; 
  animation: pulse 2s infinite;
}
.status-normal { 
  color: #51cf66 !important; 
}
.status-unknown { 
  color: #868e96 !important; 
  font-style: italic !important;
}
.status-no-path { 
  color: #868e96 !important; 
  font-style: italic !important;
}

/* ç½®é¡¶è¡Œæ ·å¼ */
.pinned-row {
  background: rgba(255, 107, 107, 0.05) !important;
  border-left: 3px solid #ff6b6b !important;
}

/* è„‰å†²åŠ¨ç”» */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
</style>`);

// æ˜¾ç¤ºæ ‡é¢˜
dv.el("h2", "ğŸ“º è¿½ç•ªåˆ—è¡¨ - åœ¨çœ‹");

// --- å·¥å…·å‡½æ•° ---

// ä»ç¬”è®°å†…å®¹æå–å­—æ®µ
function extractField(content, field) {
  if (!content) return null;
  const esc = field.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  const re = new RegExp("^\\|\\s*" + esc + "\\s*\\|\\s*([^|\\n]+?)\\s*\\|", "m");
  const m = content.match(re);
  if (m) {
    return m[1].trim().replace(/`/g, '');
  }
  return null;
}

// æå–å·²è§‚çœ‹é›†æ•°
function extractWatchedEpisodes(content) {
  const match = content.match(/\*\*å·²è§‚çœ‹é›†æ•°\*\*ï¼š\s*(\d+)/);
  return match ? parseInt(match[1]) : 0;
}

// ä»Frontmatteræå–å­—æ®µ
function extractFrontmatter(content) {
  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
  if (!frontmatterMatch) return null;
  
  const yamlContent = frontmatterMatch[1];
  const frontmatter = {};
  
  yamlContent.split('\n').forEach(line => {
    const match = line.match(/^([^:]+):\s*(.+)$/);
    if (match) {
      let value = match[2].trim();
      // ç§»é™¤å¼•å·
      if ((value.startsWith('"') && value.endsWith('"')) || 
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.substring(1, value.length - 1);
      }
      frontmatter[match[1].trim()] = value;
    }
  });
  
  return frontmatter;
}

// ä»è·¯å¾„æå–å­£åº¦ä¿¡æ¯
function extractSeasonFromPath(filePath) {
  const match = filePath.match(/\/(\d{4})\/(\d{2})æœˆæ–°ç•ª/);
  if (match) {
    const year = match[1];
    const month = match[2];
    return `${year}å¹´${month}æœˆ`;
  }
  return "æœªçŸ¥å­£åº¦";
}

// æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹æ›´æ–°çŠ¶æ€
async function checkDownloadUpdate(filePath) {
  try {
    const file = app.vault.getAbstractFileByPath(filePath);
    if (!file) return { hasUpdate: false, error: "æ–‡ä»¶ä¸å­˜åœ¨" };
    
    const content = await app.vault.read(file);
    const frontmatter = extractFrontmatter(content);
    if (!frontmatter) {
      return { hasUpdate: false, error: "æ— æ³•è§£æFrontmatter" };
    }
    
    const downloadPath = frontmatter.ä¸‹è½½è·¯å¾„;
    if (!downloadPath || downloadPath === "æ— ") {
      return { 
        hasUpdate: false, 
        error: "æ— ä¸‹è½½è·¯å¾„",
        downloadPath: null,
        watchedEpisodes: 0,
        fileCount: 0,
        newCount: 0
      };
    }
    
    const watchedEpisodes = extractWatchedEpisodes(content);
    
    // æ£€æŸ¥æ–‡ä»¶å¤¹
    const fs = require('fs');
    const path = require('path');
    
    const cleanPath = downloadPath.replace(/`/g, '').trim();
    
    if (!fs.existsSync(cleanPath)) {
      return { 
        hasUpdate: false, 
        error: "æ–‡ä»¶å¤¹ä¸å­˜åœ¨",
        downloadPath: cleanPath,
        watchedEpisodes,
        fileCount: 0,
        newCount: 0
      };
    }
    
    // ç»Ÿè®¡è§†é¢‘æ–‡ä»¶
    const files = fs.readdirSync(cleanPath);
    const videoExtensions = ['.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.webm', '.m4v'];
    
    const videoFiles = files.filter(file => {
      if (file.startsWith('.')) return false; // è·³è¿‡éšè—æ–‡ä»¶
      const ext = path.extname(file).toLowerCase();
      return videoExtensions.includes(ext);
    });
    
    const fileCount = videoFiles.length;
    
    // æ–°å¢ï¼šè®¡ç®—æ›´æ–°é›†æ•°ï¼ˆä¸ç¬¬ä¸€ä¸ªè„šæœ¬ä¿æŒä¸€è‡´ï¼‰
    const newCount = Math.max(0, fileCount - watchedEpisodes); // ç¡®ä¿ä¸ä¼šå‡ºç°è´Ÿæ•°
    const hasUpdate = newCount > 0;
    
    return {
      hasUpdate,
      error: null,
      downloadPath: cleanPath,
      watchedEpisodes,
      fileCount,
      newCount: newCount
    };
    
  } catch (error) {
    console.error(`æ£€æŸ¥æ›´æ–°å¤±è´¥ ${filePath}:`, error);
    return { 
      hasUpdate: false, 
      error: error.message,
      downloadPath: null,
      watchedEpisodes: 0,
      fileCount: 0,
      newCount: 0
    };
  }
}

// åˆ›å»ºæ›´æ–°çŠ¶æ€å•å…ƒæ ¼ï¼ˆä¿®æ”¹ä¸ºæ˜¾ç¤ºæ›´æ–°é›†æ•°ï¼‰
function createUpdateStatusCell(updateInfo) {
  if (updateInfo.error === "æ— ä¸‹è½½è·¯å¾„") {
    return dv.el("span", "æœªè®¾ç½®", { 
      attr: { 
        class: "status-no-path",
        title: "æœªè®¾ç½®ä¸‹è½½è·¯å¾„"
      }
    });
  }
  
  if (updateInfo.error) {
    return dv.el("span", "âŒå¤±è´¥", { 
      attr: { 
        class: "status-unknown",
        title: updateInfo.error
      }
    });
  }
  
  // ä¿®æ”¹ï¼šæ˜¾ç¤ºæ›´æ–°é›†æ•°ï¼Œä¸ç¬¬ä¸€ä¸ªè„šæœ¬ä¿æŒä¸€è‡´
  if (updateInfo.hasUpdate) {
    return dv.el("span", `ğŸ†•å·²æ›´æ–°${updateInfo.newCount}é›†`, { 
      attr: { 
        class: "status-new",
        title: `å·²çœ‹: ${updateInfo.watchedEpisodes}é›†, å®é™…æ–‡ä»¶: ${updateInfo.fileCount}ä¸ª`
      }
    });
  } else {
    return dv.el("span", `âœ… å·²åŒæ­¥`, { 
      attr: { 
        class: "status-normal",
        title: `å·²çœ‹: ${updateInfo.watchedEpisodes}é›†, å®é™…æ–‡ä»¶: ${updateInfo.fileCount}ä¸ª`
      }
    });
  }
}

// åˆ›å»ºç¬”è®°é“¾æ¥
function createNoteLink(filePath, chineseName, hasUpdate) {
  return dv.el("a", chineseName, {
    href: filePath,
    attr: {
      class: `note-link ${hasUpdate ? 'pinned' : ''}`,
      "data-href": filePath,
      "data-tooltip-position": "top",
      "aria-label": `æ‰“å¼€ ${chineseName}`,
      onclick: `(() => {
        app.workspace.openLinkText("${filePath}", "", false);
        return false;
      })()`
    }
  });
}

// åˆ›å»ºæ‰“å¼€æ–‡ä»¶å¤¹æŒ‰é’®
function createFolderButton(updateInfo) {
  if (!updateInfo.downloadPath || updateInfo.error) {
    return dv.el("button", "â€”", {
      attr: {
        class: "folder-btn disabled",
        disabled: true,
        title: updateInfo.error || "æ— ä¸‹è½½è·¯å¾„"
      }
    });
  }
  
  return dv.el("button", "ğŸ“ æ‰“å¼€", {
    attr: {
      class: "folder-btn",
      onclick: `(() => {
        const { shell } = require('electron');
        shell.openPath("${updateInfo.downloadPath.replace(/\\/g, '\\\\')}");
      })()`,
      title: `æ‰“å¼€æ–‡ä»¶å¤¹: ${updateInfo.downloadPath}`
    }
  });
}

// ä¸»ç¨‹åº
try {
  // æ”¶é›†æ‰€æœ‰bangumiç¬”è®°
  const pages = dv.pages().where(p => 
    p.file && 
    p.file.path && 
    p.file.path.startsWith(ROOT_FOLDER) &&
    p.tags && 
    (p.tags.includes("bangumi") || p.tags === "bangumi")
  ).array();
  
  const watchingItems = [];
  
  // å¤„ç†æ¯ä¸ªç¬”è®°
  for (const page of pages) {
    try {
      const filePath = page.file.path;
      const content = await app.vault.read(app.vault.getAbstractFileByPath(filePath));
      
      // æ£€æŸ¥è§‚çœ‹çŠ¶æ€
      const frontmatter = extractFrontmatter(content);
      if (!frontmatter || frontmatter.è§‚çœ‹çŠ¶æ€ !== "åœ¨çœ‹") {
        continue; // è·³è¿‡é"åœ¨çœ‹"çŠ¶æ€çš„ç¬”è®°
      }
      
      const chineseName = frontmatter.ä¸­æ–‡å || page.file.name.replace('.md', '');
      const season = extractSeasonFromPath(filePath);
      
      // æ£€æŸ¥æ›´æ–°çŠ¶æ€
      const updateInfo = await checkDownloadUpdate(filePath);
      
      watchingItems.push({
        filePath,
        fileName: page.file.name,
        chineseName,
        season,
        updateInfo,
        hasUpdate: updateInfo.hasUpdate,
        fileCount: updateInfo.fileCount,
        watchedEpisodes: updateInfo.watchedEpisodes,
        newCount: updateInfo.newCount
      });
      
    } catch (error) {
      console.error(`å¤„ç†ç¬”è®°å¤±è´¥ ${page.file.path}:`, error);
    }
  }
  
  // ç»Ÿè®¡ä¿¡æ¯
  const totalCount = watchingItems.length;
  const updateCount = watchingItems.filter(item => item.hasUpdate).length;
  
  dv.paragraph(`**ğŸ“Š ç»Ÿè®¡ï¼š** ${totalCount} éƒ¨ç•ªå‰§ä¸­ï¼Œ${updateCount} éƒ¨æœ‰æ›´æ–°\n`);
  
  // æ’åºï¼šæœ‰æ›´æ–°çš„ç½®é¡¶ï¼Œç„¶åæŒ‰æ›´æ–°é›†æ•°é™åºï¼Œç„¶åæŒ‰å­£åº¦æ’åºï¼ˆä¸ç¬¬ä¸€ä¸ªè„šæœ¬ä¿æŒä¸€è‡´ï¼‰
  watchingItems.sort((a, b) => {
    // 1. æœ‰æ›´æ–°çš„æ’åœ¨å‰é¢
    if (a.hasUpdate && !b.hasUpdate) return -1;
    if (!a.hasUpdate && b.hasUpdate) return 1;
    
    // 2. å¦‚æœéƒ½æœ‰æ›´æ–°ï¼ŒæŒ‰æ›´æ–°é›†æ•°ä»å¤§åˆ°å°æ’åº
    if (a.hasUpdate && b.hasUpdate) {
      if (a.newCount > b.newCount) return -1;
      if (a.newCount < b.newCount) return 1;
    }
    
    // 3. ç„¶åæŒ‰å­£åº¦æ’åºï¼ˆæ–°å­£åº¦åœ¨å‰ï¼‰
    const seasonA = a.season;
    const seasonB = b.season;
    if (seasonA !== seasonB) {
      return seasonB.localeCompare(seasonA);
    }
    
    // 4. æœ€åæŒ‰ä¸­æ–‡åæ’åº
    return a.chineseName.localeCompare(b.chineseName, "zh-CN");
  });
  
  // ç”Ÿæˆè¡¨æ ¼
  const tableRows = watchingItems.map(item => {
    return [
      // ä¸­æ–‡åï¼ˆé“¾æ¥åˆ°ç¬”è®°ï¼‰
      createNoteLink(item.filePath, item.chineseName, item.hasUpdate),
      
      // å¼€æ’­å­£åº¦
      dv.span(item.season, { 
        attr: { 
          style: "font-size: 12px;"
        }
      }),
      
      // æ›´æ–°çŠ¶æ€ï¼ˆç°åœ¨æ˜¾ç¤ºæ›´æ–°é›†æ•°ï¼‰
      createUpdateStatusCell(item.updateInfo),
      
      // æ‰“å¼€æ–‡ä»¶å¤¹
      createFolderButton(item.updateInfo)
    ];
  });
  
  // æ˜¾ç¤ºè¡¨æ ¼
  dv.table(
    ["ä¸­æ–‡å", "å¼€æ’­å­£åº¦", "æ›´æ–°çŠ¶æ€", "æ‰“å¼€æ–‡ä»¶å¤¹"],
    tableRows
  );
  
  } catch (error) {
  dv.paragraph(`âŒ ç”Ÿæˆè¿½ç•ªåˆ—è¡¨å¤±è´¥ï¼š${error.message}`);
  console.error("DataViewè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼š", error);
}
  
  // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
  dv.paragraph(`
  ---
  **ğŸ¯ ä½¿ç”¨è¯´æ˜ï¼š**
  1. **ç‚¹å‡»ä¸­æ–‡å**ï¼šæ‰“å¼€å¯¹åº”çš„ç•ªå‰§ç¬”è®°
  2. **ç‚¹å‡»"æ‰“å¼€æ–‡ä»¶å¤¹"**ï¼šæ‰“å¼€ä¸‹è½½çš„è§†é¢‘æ–‡ä»¶å¤¹
  3. **ğŸ†• å·²æ›´æ–°Xé›†**ï¼šè¡¨ç¤ºæœ‰Xé›†æ–°æ–‡ä»¶æœªè§‚çœ‹
  4. **âœ… å·²åŒæ­¥**ï¼šå·²è§‚çœ‹æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶
  
  **ğŸ”¢ æ’åºè§„åˆ™ï¼š**
  1. æœ‰æ›´æ–°çš„ç•ªå‰§è‡ªåŠ¨ç½®é¡¶
  2. æ›´æ–°é›†æ•°å¤šçš„æ’åœ¨å‰é¢
  3. æ— æ›´æ–°çš„æŒ‰å¼€æ’­å­£åº¦ï¼ˆæ–°â†’æ—§ï¼‰æ’åº
  4. æœ€åæŒ‰ä¸­æ–‡åç§°æ’åº
  `);
```

